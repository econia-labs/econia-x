\documentclass[table, twocolumn]{article}
\usepackage{amsmath}
\usepackage{hyperref}
\usepackage{geometry}
\usepackage[acronym]{glossaries}
\usepackage{pgfplots}
\usepackage{xcolor}
\pgfplotsset{compat=1.18}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{intersections}

% Page options.
\pagecolor{black}
\color{gray!70}
\geometry{left=35pt, top=50pt, bottom=50pt, right=35pt}

% Acronyms.
\newacronym{amm}{AMM}{Automated Market Maker}
\newacronym{cpamm}{CPAMM}{Constant Product Automated Market Maker}
\newacronym{lp}{LP}{Liquidity Provider}

% Links.
\hypersetup{colorlinks=true, allcolors={blue}}

\title{Custom Automated Market Maker}
\author{Econia Labs}
\date{}

% TikZ set for tangent lines.
\input{figures/tangent-line-style.tex}

\begin{document} % chktex 17

\maketitle

\section{Spot price}\label{sec:spot-price}

The spot price of a \gls*{cpamm} is determined by the ratio of quote reserves $q$ to
base reserves $b$ per Equation~\ref{eqn:price-defined}.

\begin{equation}\label{eqn:price-defined}
	p = \frac{q}{b}
\end{equation}

This is equal to the derivative of the constant product curve for the given reserve
amounts, as illustrated in Figure~\ref{fig:spot-price}.

\begin{figure}[!htb]
	\centering
	\input{figures/spot-price.tex}
	\caption{Spot price}\label{fig:spot-price}
\end{figure}

\section{Swap prices}\label{sec:swap-prices}

Since a swap involves a change in reserves, it alters the spot price. The initial spot
price $p_i$ is simply the spot price at the initial reserve amounts $b_i$ and $q_i$ per
Equation~\ref{eqn:swap-initial-price}.

\begin{equation}\label{eqn:swap-initial-price}
	p_i = \frac{q_i}{b_i}
\end{equation}

Similarly, the final spot price $p_f$ is the spot price at the final reserve amounts
$b_f$ and $q_f$ per Equation~\ref{eqn:swap-final-price}.

\begin{equation}\label{eqn:swap-final-price}
	p_f = \frac{q_f}{b_f}
\end{equation}

Lastly, the swap price $p_s$ is the ratio of base and quote exchanged during the swap,
and is calculated differently for buys and sells.

Equation~\ref{eqn:swap-constant-product} states that the product of base and quote at
the initial and final states is constant.

\begin{equation}\label{eqn:swap-constant-product}
	b_i \cdot q_i = b_f \cdot q_f
\end{equation}

\subsection{Swap sell}\label{ssec:swap-sell}

Figure~\ref{fig:swap-sell} illustrates a swap where base input amount $b_{in}$ is sold
for quote output amount $q_{out}$.

\begin{figure}[!htb]
	\centering
	\input{figures/swap-sell.tex}
	\caption{Swap sell}\label{fig:swap-sell}
\end{figure}

The final base and quote amounts are respectively given in
Equations~\ref{eqn:swap-sell-base-final} and~\ref{eqn:swap-sell-quote-final}.

\begin{equation}\label{eqn:swap-sell-base-final}
	b_f = b_i + b_{in}
\end{equation}

\begin{equation}\label{eqn:swap-sell-quote-final}
	q_f = q_i - q_{out}
\end{equation}

The swap price $p_s$ is given in Equation~\ref{eqn:swap-sell-price}.

\begin{equation}\label{eqn:swap-sell-price}
	p_s = \frac{q_{out}}{b_{in}}
\end{equation}

Substituting Equation~\ref{eqn:swap-sell-base-final} into
Equation~\ref{eqn:swap-constant-product} yields $q_f$ as a function of $b_{in}$ and
initial reserves, $q_f(b_i, q_i, b_{in})$, per
Equation~\ref{eqn:swap-sell-quote-final-solved}.

\begin{align}\label{eqn:swap-sell-quote-final-solved}
	b_i \cdot q_i                      & = b_f \cdot q_f \nonumber            \\
	b_i \cdot q_i                      & = (b_i + b_{in}) \cdot q_f \nonumber \\
	\frac{b_i \cdot q_i}{b_i + b_{in}} & = q_f \nonumber                      \\
	q_f(b_i, q_i, b_{in})              & = \frac{b_i \cdot q_i}{b_i + b_{in}}
\end{align}

Similarly, substituting Equation~\ref{eqn:swap-sell-quote-final-solved} into
Equation~\ref{eqn:swap-sell-quote-final} yields $q_{out}(b_i, q_i, b_{in})$
per Equation~\ref{eqn:swap-sell-quote-output}.

\begin{align}\label{eqn:swap-sell-quote-output}
	q_{out}                    & = q_i - q_f \nonumber                                       \\
	q_{out}                    & = q_i - \frac{b_i \cdot q_i}{b_i + b_{in}} \nonumber        \\
	q_{out}                    & = q_i \left( 1 - \frac{b_i}{b_i + b_{in}} \right) \nonumber \\
	q_{out}                    & = q_i \left(
	\frac{b_i + b_{in}}{b_i + b_{in}} - \frac{b_i}{b_i + b_{in}}
	\right) \nonumber                                                                        \\
	q_{out}                    & = q_i \left( \frac{b_{in}}{b_i + b_{in}} \right) \nonumber  \\
	q_{out} (b_i, q_i, b_{in}) & = \frac{q_i \cdot b_{in}}{b_i + b_{in}}
\end{align}

Lastly, substituting Equation~\ref{eqn:swap-sell-quote-output} into
Equation~\ref{eqn:swap-sell-price} yields $p_s(b_i, q_i, b_{in})$ per
Equation~\ref{eqn:swap-sell-price-solved}.

\begin{align}\label{eqn:swap-sell-price-solved}
	p_s & = \frac{q_{out}}{b_{in}} \nonumber                                       \\
	p_s & = \frac{q_i \cdot b_{in}}{b_i + b_{in}} \cdot \frac{1}{b_{in}} \nonumber \\
	p_s & = \frac{q_i}{b_i + b_{in}}
\end{align}

\end{document} % chktex 17
